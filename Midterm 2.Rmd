---
title: 'STA 137 Midterm 2: Take Home'
author: "Janice Luong Section A02"
date: "Febuary 23, 2016"
output: pdf_document
---

```{r, results = 'hide'}
#get the data
require(astsa)
data("cmort")
cmort.part = window(cmort, start = c(1970, 1), end = c(1978, 52))
```

##Question 1
```{r}
dataCmort = as.vector(cmort.part)
timeCmort = as.vector(time(cmort.part))

plot(timeCmort, dataCmort, type = "l", 
     main = "Cardiovascular Mortality from the LA Pollution Study", 
     xlab = "Time (in years)", ylab = "", col = "darkorchid1")

#remove trend
trend.fit = lm(dataCmort~timeCmort)

plot(timeCmort, dataCmort, type = "l", main = "Data with fitted trend line", 
     xlab = "Time (in years)", ylab = "")
lines(timeCmort, fitted(trend.fit), col = "tomato4")

# plot residuals after trend is removed
cmortResid = residuals(trend.fit)
plot(timeCmort, cmortResid, type="l", main = "Residuals after Trend is Removed",
     xlab = "Time (in years)", ylab = "Residuals", col = "darkgreen")
```

After removing the trend, I notice a seaonality every year, something it spikes up (increases). The increase beings at every year, it is the lowest in the middle of the year and then it slowly rises again near the end of year. Since the study takes an average weekly of the cardiovascular mortality in Los Angeles County, the d = 52.

##Question 2
```{r, results='hide'}
#remove the seasonal component by using a sum of harmonics

#use t that is in the interval [0,1]
intervalT = 1:length(cmortResid)
n = length(timeCmort)
intervalT2 = (intervalT) / n

n.harm = 26 #set to [d/2]
d = 52 #number of time pionts in each season
harm = matrix(nrow = length(intervalT2), ncol = 2*n.harm)
for(i in 1:n.harm){
  harm[,i*2-1] = sin(n/d * i *2*pi*intervalT2)
  harm[,i*2] = cos(n/d * i *2*pi*intervalT2)
}
colnames(harm)= 
    paste0(c("sin", "cos"), rep(1:n.harm, each = 2))

#fit on all of the sines and cosines
dat = data.frame(cmortResid, harm)
fit = lm(cmortResid~., data = dat)

# setup the full model and the model with only an intercept
full = lm(cmortResid~.,data = dat)
reduced = lm(cmortResid~1, data = dat)

#stepwise regression starting with the full model
#full with all sin and cos
fit.back = step(full, scope = formula(reduced), direction = "both")

#get back the original t so that we can plot over this range
t = as.vector(time(cmort.part))
```
````{r}
summary(fit.back)

#plot the estimated seasonal components
plot(t,cmortResid, type = "l", main = "Estimated Seaonson Component",
     col = "darkgrey", ylab="")
#fitted seasonal component
lines(t, fitted(fit.back), col = "red")

#plot the residuals after seasonal component is removed
ts.plot(residuals(fit.back), 
        main = "After seasonal componenets removed", ylab = "", xlab = "t")
```

The residuals look mostly stationary because it is centered around mean 0.

##Question 3
```{r}
#plot the acf and pacf of the residuals
z = residuals(fit.back)
acf(z)
pacf(z)
```

Since the ACF trails off to 0 and the PACF drops off (close) to zero after lag p, where p = 2, The time series model I believe that is appropriate for these residuals is AR(2).

##Question 4
```{r}
library(forecast)
ar.fit = auto.arima(residuals(fit.back), stepwise = FALSE)
ar.fit
```

Using the function auto.arima function, with parameters stepwise = FALSE, the best fit model is AR(2).

```{r}
auto.arima(residuals(fit.back), stepwise = TRUE)
```

Using the function auto.arima function, with parameters stepwise = TRUE, the best fit model is AR(2).

##Question 5
```{r}
#white noise
whiteNoise = ar.fit$residuals
#plot the acf and pacf of the remaining noise
acf(whiteNoise, na.action = na.pass)
pacf(whiteNoise, na.action = na.pass)
```

Based onf ACF and PACF functions, the remaining residuals are white noise because the ACF drops off after lag 1 and the PACF have no level of signifigance.

##Question 6
```{r}
#fit ARMA(3,1) model
armaFit = arima(z, order = c(2, 0, 0), include.mean = FALSE)
Box.test(armaFit$residuals, type = "Ljung-Box", lag = min(2*d, floor(n/5)))
```

$H_0$: residuals (denoted as $\left\{Y_t\right\}^{n}_{t=1}$) are independent up to some time lag h (no dependence structure remaining)

$H_a$: residuals are dependent (dependence structure remaining)

We get: $p-value$ = 0.3623 and we have level of significance at $\alpha$ = 0.05

Since the $p-value$ is greater than $\alpha$, we fail to reject $H_0$. This means that the residuals, $\left\{Y_t\right\}^{n}_{t=1}$, are independent up to some time lag h (no dependence structure remaining).